{% assign primary_category = page.categories[0] %}
{% assign related_posts = site.posts 
  | where_exp: "p", "p.categories contains primary_category" 
  | where_exp: "p", "p.url != page.url" 
  | sort: "date" 
  | reverse 
%}

{% if related_posts.size > 0 %}
  <div class="related-posts">
    <button class="collapsible">Related Posts</button>
    <div class="related-content">
      <div class="post-grid">
        {% for post in related_posts limit:3 %}
          <article class="post-card neon-card">
            {% if post.image %}
              <img src="{{ post.image | relative_url }}" class="post-card-img" alt="{{ post.title }}" />
            {% endif %}
            <h3 class="post-card-title">
              <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
            </h3>
          </article>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}
